name: "bttracker"
on:
  workflow_dispatch:
  push:
    paths:
    - 'bttracker/**'
    - 'ÔºÅbttracker/install-service.sh'
    - '.github/workflows/generated-build-bttracker.yaml'
    # - common
    branches:
    - master
env:
  NODE_ENV: production
  CI: github-actions
jobs:
  cancel:
    name: Cancel Previous Runs
    runs-on: ubuntu-latest
    steps:
      - name: cancel running workflows
        uses: GongT/cancel-previous-workflows@5cdc17f4f91a30861d1f7be16f34719371d804d7
        env:
          DELETE: "yes"
          GITHUB_TOKEN: ${{ github.token }}
  build:
    name: 'standalone build bttracker image'
    runs-on: [self-hosted, linux]
    env:
      http_proxy: http://proxy-server.:3271
      https_proxy: http://proxy-server.:3271
    steps:
      - name: 'Force Reset'
        shell: bash
        run: |
          git reset --hard --recurse-submodule
          git submodule foreach bash -c "git clean -ffdx"

      - name: 'Checkout'
        uses: actions/checkout@v2
        env:
          http_proxy: http://proxy-server.:3271
          https_proxy: http://proxy-server.:3271
        with:
          submodules: 'recursive'
          clean: true
          fetch-depth: 0
      - name: 'Fetch exists image from docker'
        shell: bash
        run: podman pull "docker://docker.io/gongt/bttracker"
        # continue-on-error: true
        env:
          http_proxy: ''
          https_proxy: ''
      - name: 'Build Image'
        run: bash -e _scripts_/ci-single-build.sh bttracker
      - name: 'Publish to docker hub'
        shell: bash
        env:
          PASSWD: ${{ secrets.DockerPassword }}
          http_proxy: ''
          https_proxy: ''
        run: ./_scripts_/retry.sh podman push "${{ env.LAST_COMMITED_IMAGE }}" --creds "gongt:$PASSWD" "docker://docker.io/gongt/bttracker"

      - name: 'Delete old images'
        shell: bash
        run: ./_scripts_/delete-old-images.sh
