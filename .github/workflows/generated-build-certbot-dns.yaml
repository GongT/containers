name: "certbot-dns"
on:
  workflow_dispatch:
  push:
    paths:
    - 'certbot-dns/**'
    - '.github/workflows/generated-build-certbot-dns.yaml'
    # - common
    branches:
    - master
env:
  NODE_ENV: production
  CI: github-actions
jobs:
  cancel:
    name: Cancel Previous Runs
    runs-on: ubuntu-latest
    steps:
      - name: cancel running workflows
        uses: GongT/cancel-previous-workflows@5cdc17f4f91a30861d1f7be16f34719371d804d7
        env:
          DELETE: "yes"
          GITHUB_TOKEN: ${{ github.token }}
  build:
    name: 'standalone build certbot-dns image'
    runs-on: [self-hosted, linux]
    env:
      http_proxy: http://proxy-server.:3271
      https_proxy: http://proxy-server.:3271
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v2
        env:
          http_proxy: http://proxy-server.:3271
          https_proxy: http://proxy-server.:3271
        with:
          submodules: 'recursive'
          clean: true
          fetch-depth: 0
      - name: 'Fetch exists image from docker'
        shell: bash
        run: podman pull "docker://docker.io/gongt/certbot-dns"
        # continue-on-error: true
        env:
          http_proxy: ''
          https_proxy: ''
      - name: 'Build Image'
        run: bash -e _scripts_/ci-single-build.sh certbot-dns
      - name: 'Publish to docker hub'
        shell: bash
        env:
          PASSWD: ${{ secrets.DockerPassword }}
          http_proxy: ''
          https_proxy: ''
        run: ./_scripts_/retry.sh podman push "${{ env.LAST_COMMITED_IMAGE }}" --creds "gongt:$PASSWD" "docker://docker.io/gongt/certbot-dns"
